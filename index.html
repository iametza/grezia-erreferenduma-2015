<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <style>

        .unitateak:hover {
            fill: #d50000;
        }

        .eskualde-mugak {
            fill: none;
            stroke: #000;
            stroke-width: 0.5px;
            stroke-linejoin: round;
        }

        .kanpo-mugak {
            fill: none;
            stroke: #000;
            stroke-width: 0.5px;
            stroke-linejoin: round;
        }

        #kontainerra {
            margin: 0 auto 0 auto;
            width: 680px;
            position: relative;
            height: 680px;
            font-family: Arial,Helvetica,sans-serif !important;
            font-size: 16px;
        }

        #mapa {
            display: block;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid black;
        }
        
        .datuak-taula {
            left: 500px;
            position: absolute;
            top: 140px;
        }
                
        #emaitza-bai, #emaitza-ez {
            font-size: 20px;
            font-weight: bold;
            text-align: right;
            width: 75px;
        }
        
        #unitatea-izena {
            font-size: 20px;
            font-weight: bold;
            left: 20px;
            position: absolute;
            text-align: center;
            top: 15px;
            width: 210px;
        }
        
        #kredituak {
            color: #333;
            font-family: Arial,Helvetica,sans-serif;
            font-size: 12px;
            left: 30px;
            position: absolute;
            top: 560px;
            width: 250px;
        }
        
        #mapa-argia-logoa {
            width: 130px;
        }
        
        a {
            color: #e50000;
            text-decoration: none;
        }
        </style>
    </head>
    <body>
        <div id="kontainerra">
			<div id="mapa"></div>
            <div id="unitatea-izena"></div>
            <div class="datuak">
                <table class="datuak-taula">
					<tr>
						<td><img src="img/ez.png"></td>
						<td id="emaitza-ez"></td>
					</tr>
                    <tr>
						<td><img src="img/bai.png"></td>
						<td id="emaitza-bai"></td>
					</tr>
				</table>
            </div>
            <div id="kredituak">
				<a href="http://www.argia.eus"><img src="http://www.argia.eus/template/images/argia.jpg" id="mapa-argia-logoa"></a>
				<div>
				  Infografia: <strong>Asier Iturralde Sarasola</strong>&nbsp;<a href="http://www.twitter.com/aldatsa">@aldatsa</a>
				</div>
				<div>
					Datuak: Greziako Gobernua
				</div>
			</div>
        </div>
        
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script>
            
            // Maparen svg elementuaren neurriak.
            var width = 680,
                height = 680;
            
            // Maparen proiekzioaren xehetasunak.
            var projection = d3.geo.mercator()
                .center([24.0, 38.3])
                .scale(4100)
                .translate([width / 2, height / 2]);
            
            // Maparen bidearen generatzailea.
            var path = d3.geo.path()
                .projection(projection);

            // Maparen svg elementua DOMera gehitu eta neurriak ezarri.
            var svg = d3.select("#mapa").append("svg")
                .attr("width", width)
                .attr("height", height);
            
            // Emaitzak irakurri.
            d3.csv("datuak/emaitzak.csv", function(error, datuak) {
                
                if (error) return console.error(error);
                console.log(datuak);
                    
                d3.json("greziako-eskualdeak.json", function(error, grezia) {
                    
                    if (error) return console.error(error);
                    console.log(grezia.objects.eskualdeak);
                    
                    // d: Emaitzen arrayko eskualde bakoitzaren propietateak biltzen dituen objektua.
                    // i: indizea
                    datuak.forEach(function(d, i) {
                        
                        // e: Datu geografikoetako eskualdearen propietateak
                        // j: indizea
                        topojson.feature(grezia, grezia.objects.eskualdeak).features.forEach(function(e, j) {
                            
                            if (d.Eskualdea === e.properties.IZENA) {
                                e.properties.datuak = d;
                            }
                            
                        });
                        
                    });
                    
                    svg.selectAll(".unitateak")
                       .data(topojson.feature(grezia, grezia.objects.eskualdeak).features)
                       .enter().append("path")
                       .attr("class", "unitateak")
                       .attr("d", path)
                       .attr("fill", function(d) {
                           
                           // Bai: #3E9A97
                           // Ez: #EC682E
                           
                           // Ezetza nagusitu bada...
                           if (parseFloat(d.properties.datuak.Ez) > 50.0) {
                               return "#EC682E";
                           }
                           
                           // Baietza nagusitu bada...
                           return "#3E9A97";
                           
                       })
                       .on("mouseover", function(d) {
                           
                           //$("#unitatea-izena").text(d.properties.PER + " - " + d.properties.IZENA);
                           $("#unitatea-izena").text(d.properties.IZENA_EUS);
                           
                           $("#emaitza-bai").text("%" + (100.0 - parseFloat(d.properties.datuak.Ez)).toFixed(2).replace(".", ","));
                           $("#emaitza-ez").text("%" + d.properties.datuak.Ez.replace(".", ","));
                           
                       });
                    
                    // Eskualdeen arteko mugak (a !== b)
                    svg.append("path")
                        .datum(topojson.mesh(grezia, grezia.objects.eskualdeak, function(a, b) { return a !== b; }))
                        .attr("d", path)
                        .attr("class", "eskualde-mugak");
                    
                    // Kanpo-mugak (a === b)
                    svg.append("path")
                        .datum(topojson.mesh(grezia, grezia.objects.eskualdeak, function(a, b) { return a === b; }))
                        .attr("d", path)
                        .attr("class", "kanpo-mugak");
                });
                
            });
        </script>
    </body>
</html>
